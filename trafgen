#!/bin/bash
#
# trafgen - High-Performance Traffic Generator using mz (Mausezahn)
#
# 1Gbps+ 트래픽 생성 도구
# mz (netsniff-ng 패키지)를 기반으로 동작
#
# Install: sudo apt-get install netsniff-ng
#

set -e

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Default values
INTERFACE=""
DST_IP=""
DST_MAC=""
SRC_IP=""
SRC_MAC=""
SRC_PORT=10000
DST_PORT=5001
PACKET_SIZE=1472
COUNT=0           # 0 = infinite
DELAY="0"         # 0 = max speed
RATE_MBPS=0
DURATION=0
VLAN_ID=""
VLAN_PRIO=0
DSCP=0
PROTOCOL="udp"
STREAMS=1
PAYLOAD=""
VERBOSE=0
DRY_RUN=0

# Process tracking
PIDS=()
START_TIME=0
TOTAL_PACKETS=0

#=============================================================================
# Helper Functions
#=============================================================================

print_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
  _____            __
 |_   _| __ __ _ / _| __ _  ___ _ __
   | || '__/ _` | |_ / _` |/ _ \ '_ \
   | || | | (_| |  _| (_| |  __/ | | |
   |_||_|  \__,_|_|  \__, |\___|_| |_|
                     |___/
EOF
    echo -e "  High-Performance Traffic Generator v${VERSION}"
    echo -e "  Based on mz (Mausezahn)${NC}"
    echo ""
}

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_usage() {
    cat << EOF
Usage: $(basename $0) [OPTIONS]

Required:
  -i, --interface IFACE    Network interface (e.g., enp11s0, eth0)
  -d, --dst-ip IP          Destination IP address
  -m, --dst-mac MAC        Destination MAC address (xx:xx:xx:xx:xx:xx)

Traffic Control:
  -r, --rate MBPS          Target rate in Mbps (0 = line rate, default: 0)
  -c, --count NUM          Number of packets (0 = infinite, default: 0)
  -t, --duration SEC       Duration in seconds (overrides count)
  -n, --streams NUM        Number of parallel streams (default: 1)

Packet Options:
  -l, --length SIZE        Packet size in bytes (default: 1472)
  -s, --src-ip IP          Source IP address (default: auto)
  -S, --src-mac MAC        Source MAC address (default: auto)
  -p, --port PORT          Destination port (default: 5001)
  -P, --src-port PORT      Source port base (default: 10000)
  -T, --proto PROTO        Protocol: udp, tcp, icmp, arp (default: udp)
  -x, --payload TEXT       Custom payload string

QoS Options:
  -v, --vlan ID            VLAN ID (1-4094)
  -q, --vlan-prio PRI      VLAN priority 0-7 (default: 0)
  -D, --dscp VALUE         DSCP value 0-63 (default: 0)

Other:
  --dry-run                Show mz command without executing
  -V, --verbose            Verbose output
  -h, --help               Show this help
  --version                Show version

Examples:
  # Maximum rate UDP flood
  sudo $(basename $0) -i eth0 -d 192.168.1.100 -m 00:11:22:33:44:55

  # 1 Gbps for 60 seconds
  sudo $(basename $0) -i eth0 -d 192.168.1.100 -m 00:11:22:33:44:55 -r 1000 -t 60

  # 4 parallel streams, VLAN tagged
  sudo $(basename $0) -i eth0 -d 192.168.1.100 -m 00:11:22:33:44:55 -n 4 -v 100 -q 5

  # TCP SYN flood to port 80
  sudo $(basename $0) -i eth0 -d 192.168.1.100 -m 00:11:22:33:44:55 -T tcp -p 80

  # Small packets for high pps
  sudo $(basename $0) -i eth0 -d 192.168.1.100 -m 00:11:22:33:44:55 -l 64
EOF
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Root privileges required. Run with sudo."
        exit 1
    fi
}

check_mz() {
    if ! command -v mz &> /dev/null; then
        log_error "mz (Mausezahn) not found"
        echo ""
        echo "Install with:"
        echo "  Ubuntu/Debian: sudo apt-get install netsniff-ng"
        echo "  RHEL/CentOS:   sudo yum install netsniff-ng"
        echo "  Arch:          sudo pacman -S netsniff-ng"
        exit 1
    fi
}

check_interface() {
    if ! ip link show "$INTERFACE" &> /dev/null; then
        log_error "Interface '$INTERFACE' not found"
        echo ""
        echo "Available interfaces:"
        ip -o link show | awk -F': ' '{print "  " $2}'
        exit 1
    fi
}

get_interface_ip() {
    ip -4 addr show "$1" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1
}

get_interface_mac() {
    cat /sys/class/net/"$1"/address 2>/dev/null
}

validate_mac() {
    local mac="$1"
    if [[ ! "$mac" =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]; then
        log_error "Invalid MAC address format: $mac"
        echo "Expected format: xx:xx:xx:xx:xx:xx"
        exit 1
    fi
}

validate_ip() {
    local ip="$1"
    if [[ ! "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        log_error "Invalid IP address format: $ip"
        exit 1
    fi
}

#=============================================================================
# Rate Calculation
#=============================================================================

calculate_delay() {
    local rate_mbps=$1
    local pkt_size=$2
    local streams=$3

    if [[ $rate_mbps -eq 0 ]]; then
        echo "0"
        return
    fi

    # Rate per stream
    local rate_per_stream=$((rate_mbps / streams))
    if [[ $rate_per_stream -lt 1 ]]; then
        rate_per_stream=1
    fi

    # bits per packet
    local bits_per_pkt=$((pkt_size * 8))

    # packets per second needed
    local pps=$((rate_per_stream * 1000000 / bits_per_pkt))

    if [[ $pps -gt 0 ]]; then
        # delay in microseconds
        local delay_us=$((1000000 / pps))
        if [[ $delay_us -lt 1 ]]; then
            echo "0"
        elif [[ $delay_us -lt 1000 ]]; then
            echo "${delay_us}usec"
        elif [[ $delay_us -lt 1000000 ]]; then
            echo "$((delay_us / 1000))msec"
        else
            echo "$((delay_us / 1000000))sec"
        fi
    else
        echo "0"
    fi
}

#=============================================================================
# Traffic Generation
#=============================================================================

build_mz_command() {
    local stream_id=$1
    local src_port=$((SRC_PORT + stream_id))

    local cmd="mz $INTERFACE"

    # Packet count
    if [[ $COUNT -gt 0 ]]; then
        cmd+=" -c $COUNT"
    else
        cmd+=" -c 0"
    fi

    # Delay for rate limiting
    if [[ "$DELAY" != "0" ]]; then
        cmd+=" -d $DELAY"
    fi

    # Source MAC
    if [[ -n "$SRC_MAC" ]]; then
        cmd+=" -a $SRC_MAC"
    fi

    # Destination MAC
    cmd+=" -b $DST_MAC"

    # Source IP
    if [[ -n "$SRC_IP" ]]; then
        cmd+=" -A $SRC_IP"
    fi

    # Destination IP
    cmd+=" -B $DST_IP"

    # VLAN tagging
    if [[ -n "$VLAN_ID" ]]; then
        cmd+=" -Q $VLAN_PRIO:$VLAN_ID"
    fi

    # Protocol specific options
    case $PROTOCOL in
        udp)
            cmd+=" -t udp \"sp=$src_port,dp=$DST_PORT"
            if [[ $DSCP -gt 0 ]]; then
                cmd+=",dscp=$DSCP"
            fi
            cmd+="\""
            ;;
        tcp)
            cmd+=" -t tcp \"sp=$src_port,dp=$DST_PORT,flags=syn"
            if [[ $DSCP -gt 0 ]]; then
                cmd+=",dscp=$DSCP"
            fi
            cmd+="\""
            ;;
        icmp)
            cmd+=" -t icmp \"ping\""
            ;;
        arp)
            cmd+=" -t arp"
            ;;
    esac

    # Packet size (padding)
    cmd+=" -p $PACKET_SIZE"

    # Payload
    if [[ -n "$PAYLOAD" ]]; then
        cmd+=" -P \"$PAYLOAD\""
    fi

    echo "$cmd"
}

start_stream() {
    local stream_id=$1
    local cmd=$(build_mz_command $stream_id)

    if [[ $DRY_RUN -eq 1 ]]; then
        echo "[Stream $stream_id] $cmd"
        return
    fi

    if [[ $VERBOSE -eq 1 ]]; then
        log_info "[Stream $stream_id] $cmd"
    fi

    eval "$cmd" 2>/dev/null &
    PIDS+=($!)
}

stop_all() {
    echo ""
    log_info "Stopping traffic generation..."

    for pid in "${PIDS[@]}"; do
        kill "$pid" 2>/dev/null || true
    done

    wait 2>/dev/null || true

    # Calculate duration
    local end_time=$(date +%s)
    local duration=$((end_time - START_TIME))

    echo ""
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}Traffic generation completed${NC}"
    echo "  Duration: ${duration} seconds"
    echo "  Streams:  ${#PIDS[@]}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
}

#=============================================================================
# Main
#=============================================================================

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -i|--interface) INTERFACE="$2"; shift 2 ;;
        -d|--dst-ip) DST_IP="$2"; shift 2 ;;
        -m|--dst-mac) DST_MAC="$2"; shift 2 ;;
        -s|--src-ip) SRC_IP="$2"; shift 2 ;;
        -S|--src-mac) SRC_MAC="$2"; shift 2 ;;
        -p|--port) DST_PORT="$2"; shift 2 ;;
        -P|--src-port) SRC_PORT="$2"; shift 2 ;;
        -l|--length) PACKET_SIZE="$2"; shift 2 ;;
        -r|--rate) RATE_MBPS="$2"; shift 2 ;;
        -c|--count) COUNT="$2"; shift 2 ;;
        -t|--duration) DURATION="$2"; shift 2 ;;
        -n|--streams) STREAMS="$2"; shift 2 ;;
        -v|--vlan) VLAN_ID="$2"; shift 2 ;;
        -q|--vlan-prio) VLAN_PRIO="$2"; shift 2 ;;
        -D|--dscp) DSCP="$2"; shift 2 ;;
        -T|--proto) PROTOCOL="$2"; shift 2 ;;
        -x|--payload) PAYLOAD="$2"; shift 2 ;;
        -V|--verbose) VERBOSE=1; shift ;;
        --dry-run) DRY_RUN=1; shift ;;
        -h|--help) print_usage; exit 0 ;;
        --version) echo "trafgen v${VERSION}"; exit 0 ;;
        *) log_error "Unknown option: $1"; print_usage; exit 1 ;;
    esac
done

# Print banner
print_banner

# Validate requirements
if [[ -z "$INTERFACE" || -z "$DST_IP" || -z "$DST_MAC" ]]; then
    log_error "Missing required arguments"
    echo ""
    print_usage
    exit 1
fi

check_root
check_mz
check_interface
validate_mac "$DST_MAC"
validate_ip "$DST_IP"

# Auto-detect source MAC if not specified
if [[ -z "$SRC_MAC" ]]; then
    SRC_MAC=$(get_interface_mac "$INTERFACE")
fi

# Auto-detect source IP if not specified
if [[ -z "$SRC_IP" ]]; then
    SRC_IP=$(get_interface_ip "$INTERFACE")
fi

# Calculate delay from rate
DELAY=$(calculate_delay $RATE_MBPS $PACKET_SIZE $STREAMS)

# Print configuration
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}Configuration${NC}"
echo -e "${CYAN}───────────────────────────────────────────────────────────────${NC}"
printf "  %-14s %s (%s)\n" "Interface:" "$INTERFACE" "$SRC_MAC"
printf "  %-14s %s\n" "Source IP:" "${SRC_IP:-auto}"
printf "  %-14s %s (%s)\n" "Destination:" "$DST_IP" "$DST_MAC"
printf "  %-14s %s -> %s\n" "Ports:" "$SRC_PORT" "$DST_PORT"
printf "  %-14s %s\n" "Protocol:" "$PROTOCOL"
printf "  %-14s %d bytes\n" "Packet Size:" "$PACKET_SIZE"
printf "  %-14s %s\n" "Rate:" "$([ $RATE_MBPS -eq 0 ] && echo 'Line rate (max)' || echo "${RATE_MBPS} Mbps")"
printf "  %-14s %s\n" "Delay:" "$([ "$DELAY" = "0" ] && echo 'None (max speed)' || echo "$DELAY")"
printf "  %-14s %d\n" "Streams:" "$STREAMS"
printf "  %-14s %s\n" "Duration:" "$([ $DURATION -eq 0 ] && echo 'Infinite' || echo "${DURATION} seconds")"
[[ -n "$VLAN_ID" ]] && printf "  %-14s %s (priority: %s)\n" "VLAN:" "$VLAN_ID" "$VLAN_PRIO"
[[ $DSCP -gt 0 ]] && printf "  %-14s %d\n" "DSCP:" "$DSCP"
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Dry run - just show commands
if [[ $DRY_RUN -eq 1 ]]; then
    log_info "Dry run mode - commands that would be executed:"
    echo ""
    for ((i=0; i<STREAMS; i++)); do
        start_stream $i
    done
    exit 0
fi

# Setup cleanup trap
trap stop_all EXIT INT TERM

# Record start time
START_TIME=$(date +%s)

# Start all streams
log_info "Starting $STREAMS stream(s)..."
echo ""

for ((i=0; i<STREAMS; i++)); do
    start_stream $i
    echo -e "  ${GREEN}✓${NC} Stream $i started (PID: ${PIDS[-1]})"
done

echo ""
log_info "Traffic generation active. Press Ctrl+C to stop."
echo ""

# Wait for duration or forever
if [[ $DURATION -gt 0 ]]; then
    sleep $DURATION
else
    # Wait for all processes
    wait
fi
